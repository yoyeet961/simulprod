function escape(n){var t=n;return t=t.replace(/&/g,"&amp;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t.replace(/"/g,"&quot;")}function diffString(n,t){var f,r,o;n=n.replace(/\s+$/,"");t=t.replace(/\s+$/,"");var i=diff(n==""?[]:n.split(/\s+/),t==""?[]:t.split(/\s+/)),e="",u=n.match(/\s+/g);if(u==null?u=["\n"]:u.push("\n"),f=t.match(/\s+/g),f==null?f=["\n"]:f.push("\n"),i.n.length==0)for(r=0;r<i.o.length;r++)e+="<del>"+escape(i.o[r])+u[r]+"<\/del>";else{if(i.n[0].text==null)for(t=0;t<i.o.length&&i.o[t].text==null;t++)e+="<del>"+escape(i.o[t])+u[t]+"<\/del>";for(r=0;r<i.n.length;r++)if(i.n[r].text==null)e+="<ins>"+escape(i.n[r])+f[r]+"<\/ins>";else{for(o="",t=i.n[r].row+1;t<i.o.length&&i.o[t].text==null;t++)o+="<del>"+escape(i.o[t])+u[t]+"<\/del>";e+=" "+i.n[r].text+f[r]+o}}return e}function randomColor(){return"rgb("+Math.random()*100+"%, "+Math.random()*100+"%, "+Math.random()*100+"%)"}function diffString2(n,t){var r,u,f,o,e,s,i;for(n=n.replace(/\s+$/,""),t=t.replace(/\s+$/,""),r=diff(n==""?[]:n.split(/\s+/),t==""?[]:t.split(/\s+/)),u=n.match(/\s+/g),u==null?u=["\n"]:u.push("\n"),f=t.match(/\s+/g),f==null?f=["\n"]:f.push("\n"),o="",e=[],i=0;i<r.o.length;i++)e[i]=randomColor(),o+=r.o[i].text!=null?'<span style="background-color: '+e[i]+'">'+escape(r.o[i].text)+u[i]+"<\/span>":"<del>"+escape(r.o[i])+u[i]+"<\/del>";for(s="",i=0;i<r.n.length;i++)s+=r.n[i].text!=null?'<span style="background-color: '+e[r.n[i].row]+'">'+escape(r.n[i].text)+f[i]+"<\/span>":"<ins>"+escape(r.n[i])+f[i]+"<\/ins>";return{o:o,n:s}}function diff(n,t){for(var r={},u={},i=0;i<t.length;i++)r[t[i]]==null&&(r[t[i]]={rows:[],o:null}),r[t[i]].rows.push(i);for(i=0;i<n.length;i++)u[n[i]]==null&&(u[n[i]]={rows:[],n:null}),u[n[i]].rows.push(i);for(i in r)r[i].rows.length==1&&typeof u[i]!="undefined"&&u[i].rows.length==1&&(t[r[i].rows[0]]={text:t[r[i].rows[0]],row:u[i].rows[0]},n[u[i].rows[0]]={text:n[u[i].rows[0]],row:r[i].rows[0]});for(i=0;i<t.length-1;i++)t[i].text!=null&&t[i+1].text==null&&t[i].row+1<n.length&&n[t[i].row+1].text==null&&t[i+1]==n[t[i].row+1]&&(t[i+1]={text:t[i+1],row:t[i].row+1},n[t[i].row+1]={text:n[t[i].row+1],row:i+1});for(i=t.length-1;i>0;i--)t[i].text!=null&&t[i-1].text==null&&t[i].row>0&&n[t[i].row-1].text==null&&t[i-1]==n[t[i].row-1]&&(t[i-1]={text:t[i-1],row:t[i].row-1},n[t[i].row-1]={text:n[t[i].row-1],row:i-1});return{o:n,n:t}}(function(n){typeof define=="function"&&define.amd?define(n):window.purl=n()})(function(){function c(n,t){for(var u=decodeURI(n),e=h[t||!1?"strict":"loose"].exec(u),i={attr:{},param:{},seg:{}},r=14;r--;)i.attr[o[r]]=e[r]||"";return i.param.query=f(i.attr.query),i.param.fragment=f(i.attr.fragment),i.seg.path=i.attr.path.replace(/^\/+|\/+$/g,"").split("/"),i.seg.fragment=i.attr.fragment.replace(/^\/+|\/+$/g,"").split("/"),i.attr.base=i.attr.host?(i.attr.protocol?i.attr.protocol+"://"+i.attr.host:i.attr.host)+(i.attr.port?":"+i.attr.port:""):"",i}function l(n){var t=n.tagName;return typeof t!="undefined"?e[t.toLowerCase()]:t}function u(n,t){var i,r;if(n[t].length===0)return n[t]={};i={};for(r in n[t])i[r]=n[t][r];return n[t]=i,i}function r(t,f,e,o){var h=t.shift(),s;h?(s=f[e]=f[e]||[],"]"==h?n(s)?""!==o&&s.push(o):"object"==typeof s?s[w(s).length]=o:s=f[e]=[f[e],o]:~h.indexOf("]")?(h=h.substr(0,h.length-1),!i.test(h)&&n(s)&&(s=u(f,e)),r(t,s,h,o)):(!i.test(h)&&n(s)&&(s=u(f,e)),r(t,s,h,o))):n(f[e])?f[e].push(o):f[e]="object"==typeof f[e]?o:"undefined"==typeof f[e]?o:[f[e],o]}function a(t,u,f){var s,e,o;if(~u.indexOf("]"))s=u.split("["),r(s,t,"base",f);else{if(!i.test(u)&&n(t.base)){e={};for(o in t.base)e[o]=t.base[o];t.base=e}u!==""&&v(t.base,u,f)}return t}function f(n){return p(String(n).split(/&|;/),function(n,t){try{t=decodeURIComponent(t.replace(/\+/g," "))}catch(e){}var u=t.indexOf("="),f=y(t),r=t.substr(0,f||u),i=t.substr(f||u,t.length);return i=i.substr(i.indexOf("=")+1,i.length),r===""&&(r=t,i=""),a(n,r,i)},{base:{}}).base}function v(t,i,r){var u=t[i];typeof u=="undefined"?t[i]=r:n(u)?u.push(r):t[i]=[u,r]}function y(n){for(var u=n.length,r,t,i=0;i<u;++i)if(t=n[i],"]"==t&&(r=!1),"["==t&&(r=!0),"="==t&&!r)return i}function p(n,t){for(var i=0,u=n.length>>0,r=arguments[2];i<u;)i in n&&(r=t.call(undefined,r,n[i],i,n)),++i;return r}function n(n){return Object.prototype.toString.call(n)==="[object Array]"}function w(n){var t=[];for(var i in n)n.hasOwnProperty(i)&&t.push(i);return t}function t(n,t){return arguments.length===1&&n===!0&&(t=!0,n=undefined),t=t||!1,n=n||window.location.toString(),{data:c(n,t),attr:function(n){return n=s[n]||n,typeof n!="undefined"?this.data.attr[n]:this.data.attr},param:function(n){return typeof n!="undefined"?this.data.param.query[n]:this.data.param.query},fparam:function(n){return typeof n!="undefined"?this.data.param.fragment[n]:this.data.param.fragment},segment:function(n){return typeof n=="undefined"?this.data.seg.path:(n=n<0?this.data.seg.path.length+n:n-1,this.data.seg.path[n])},fsegment:function(n){return typeof n=="undefined"?this.data.seg.fragment:(n=n<0?this.data.seg.fragment.length+n:n-1,this.data.seg.fragment[n])}}}var e={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href",embed:"src",object:"data"},o=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],s={anchor:"fragment"},h={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},i=/^[0-9]+$/;return t.jQuery=function(n){n!=null&&(n.fn.url=function(i){var r="";return this.length&&(r=n(this).attr(l(this[0]))||""),t(r,i)},n.url=t)},t.jQuery(window.jQuery),t});angular.module("DevOpsApp",["ngGrid"]);angular.module("DevOpsApp").factory("pageModel",["$window",function(n){"use strict";var t,i;return t=function(){if(!angular.isDefined(n.PageModel)||!angular.isDefined(n.PageModel.ConfigTypeList))throw new Error("PageModel.ConfigTypeList is not defined");return n.PageModel.ConfigTypeList},i=function(){if(!angular.isDefined(n.PageModel)||!angular.isDefined(n.PageModel.EnvironmentList))throw new Error("PageModel.EnvironmentList is not defined");return n.PageModel.EnvironmentList},{getConfigTypes:t,getEnvironments:i}}]);angular.module("DevOpsApp").factory("preemptibleWatcher",function(){"use strict";var n=function(n,t){var i,u,r,e,f,o=angular.equals,s,h;return u=n.$eval(t),r=angular.copy(u),n.$watch(t,function(n,t){n!==t&&(o(n,r)||(r=angular.copy(n),angular.isFunction(f)&&f.call(null,n,t)))},!0),h=function(n){return $.each(n,function(n,t){if(angular.isDefined(i[n]))throw new Error("mutator '"+n+"' is already defined");i[n]=function(){var n=Array.prototype.slice.call(arguments);return n.unshift(r,u),t.apply(null,n)}}),i},e=function(n){return f=n,i},s=function(n){return o=n,i},i={onChange:e,mutators:h,compareWith:s}};return{create:function(t,i){return new n(t,i)}}});angular.module("DevOpsApp").factory("diffFetcher",["$http","$q",function(n,t){"use strict";var r,i=!1;return r=function(r){var u,f,e;return u={success:function(n){return f=n,u},error:function(n){return e=n,u}},i!==!1&&(i.resolve(),i=!1),i=t.defer(),n({method:"post",url:"GetDiffData",data:r,timeout:i}).success(function(){i=!1;angular.isFunction(f)&&f.apply(null,arguments)}).error(function(){i=!1;angular.isFunction(e)&&e.apply(null,arguments)}),u},{fetchDiff:r}}]);angular.module("DevOpsApp").controller("DatabasesDiffCtrl",["$scope","$timeout","pageModel","preemptibleWatcher","diffFetcher",function(n,t,i,r,u){"use strict";var y,c,f,s,l,h,a={},p,w,o,v,e;f={Identical:0,Different:1,MissingFirst:2,MissingSecond:3,"0":"Identical","1":"Different","2":"MissingFirst","3":"MissingSecond"};y='<div class="ngCellText" ng-class="getCompareTypeCellClass(col.colIndex(), row.getProperty(col.field))" ng-attr-title="{{getCompareTypeCellContents(row.getProperty(col.field))}}"><span ng-cell-text ng-bind="getCompareTypeCellContents(row.getProperty(col.field))"><\/span><a class="show-ddl-link" ng-click="openDDLWindow(row)" ng-bind="getCompareCellShowLabel(row.getProperty(col.field))"><\/a><\/div>';c='<div class="ngCellText" ng-class="col.colIndex()" ng-attr-title="{{row.getProperty(col.field)}}"><span ng-cell-text>{{row.getProperty(col.field)}}<\/span><\/div>';n.environments=i.getEnvironments();$.each(n.environments,function(n,t){a[t.ID]=t.Name});n.columnDefs=[{field:"name",displayName:"Name",cellTemplate:c},{field:"type",displayName:"Type",cellTemplate:c},{field:"compareType",displayName:"Diff",cellTemplate:y}];n.sortInfo={columns:[],fields:[],directions:[]};n.viewModel={isLoaded:!1,isShowingDDL:!1,isShowingDiff:!1,isFetching:!1,totalServerItems:0,primaryEnvironmentName:"",compareEnvironmentName:"",message:{text:!1,type:""}},function(){var t,i;n.filterOptions={primaryEnvironmentID:function(i){return angular.isDefined(i)&&(t=i,n.viewModel.primaryEnvironmentName=a[i]),t},compareEnvironmentID:function(t){return angular.isDefined(t)&&(i=t,n.viewModel.compareEnvironmentName=a[t]),i},options:{ShowMissing:!0,ShowDifferent:!0,ShowIdentical:!1},filterText:null,useExternalFilter:!0};n.filterOptions.primaryEnvironmentID(1);n.filterOptions.compareEnvironmentID(13)}();n.pagingOptions={pageSizes:[25,50,100,250,1e3],pageSize:100,currentPage:1};n.gridData=null;n.warning=function(n){h("warning",n);l()};n.error=function(n){h("error",n);l()};n.getCompareTypeCellClass=function(n,t){return n+" compare-type-"+f[t].toLowerCase()};n.getCompareTypeCellContents=function(n){switch(n){case f.Identical:case f.Different:return f[n];case f.MissingFirst:return"Missing from first environment";case f.MissingSecond:return"Missing from second environment";default:throw new Error("unknown compareType '"+n+"'");}};n.getCompareCellShowLabel=function(n){switch(n){case f.Identical:case f.MissingFirst:case f.MissingSecond:return"(View DDL)";case f.Different:return"(View Diff)";default:throw new Error("unknown compareType '"+n+"'");}};n.openDDLWindow=function(t){var r,i=s[t.rowIndex];n.viewModel.isShowingDDL=!0;n.viewModel.isShowingDiff=i.CompareType==f.Different;n.viewModel.primaryEnvironmentDDL=i.CompareType==f.MissingFirst?"[Missing]":"";n.viewModel.compareEnvironmentDDL=i.CompareType==f.MissingSecond?"[Missing]":"";i.FirstEnvironmentValues&&(r=[],$.each(i.FirstEnvironmentValues,function(n,t){r.push(t.DDL)}),n.viewModel.primaryEnvironmentDDL=r.join("\n\n**********\n\n"));i.SecondEnvironmentValues&&(r=[],$.each(i.SecondEnvironmentValues,function(n,t){r.push(t.DDL)}),n.viewModel.compareEnvironmentDDL=r.join("\n\n**********\n\n"));n.viewModel.primaryEnvironmentDDL==""&&i.Type=="DATABASE"&&(n.viewModel.primaryEnvironmentDDL="[No DDL for databases]");n.viewModel.compareEnvironmentDDL==""&&i.Type=="DATABASE"&&(n.viewModel.compareEnvironmentDDL="[No DDL for databases]");n.viewModel.isShowingDiff&&i.FirstEnvironmentValues&&i.SecondEnvironmentValues&&(r=i.FirstEnvironmentValues.length==1&&i.SecondEnvironmentValues.length==1?window.diffString(i.FirstEnvironmentValues[0].DDL,i.SecondEnvironmentValues[0].DDL).trim():"Cannot show diff because one of the environments contains multiple DDLs.",$("#diff-text").html(r))};n.closeDDLWindow=function(){n.viewModel.isShowingDDL=!1};n.getDDLContentClass=function(){return n.viewModel.isShowingDiff?"showing-diff":""};n.fetchData=function(){n.pagingOptions.currentPage!==1&&e.setCurrentPage(1);o()};n.gridOptions={data:"gridData",enablePaging:!0,showFooter:!0,totalServerItems:"viewModel.totalServerItems",pagingOptions:n.pagingOptions,filterOptions:n.filterOptions,plugins:[new ngGridFlexibleHeightPlugin],columnDefs:"columnDefs",enableColumnResize:!0,sortInfo:n.sortInfo,useExternalSorting:!0};h=function(t,i){n.viewModel.message.type=t;n.viewModel.message.text=i};l=function(){t(function(){h("","")},4500)};p=function(t){var i;n.viewModel.totalServerItems=t.TotalMatchingItems;n.viewModel.mostRecentlyUpdated=t.MostRecentlyUpdated;n.gridData=[];s=t.PagedItems;s.length!==0&&$.each(s,function(t,r){i={name:r.DisplayName,type:r.Type,compareType:r.CompareType};n.gridData.push(i)});n.viewModel.isFetching=!1};w=function(){var t=0,i,r,u=$.url().param();$.each(u,function(u,f){++t;switch(u){case"pageNumber":e.setCurrentPage(parseInt(f));break;case"pageSize":e.setPageSize(parseInt(f));break;case"sortColumn":i=f;break;case"sortDirection":r=f==="desc";break;case"primaryEnvironmentID":n.filterOptions.primaryEnvironmentID(parseInt(f));break;case"compareEnvironmentID":n.filterOptions.compareEnvironmentID(parseInt(f));break;case"options":$.each(f,function(t,i){n.filterOptions.options[t]=i==="true"});break;case"filterText":n.filterOptions.filterText=f;break;default:--t}});t>0&&(typeof i=="string"&&v.sortBy(i,r),o())};o=function(){var t,i;n.viewModel.isFetching=!0;t={primaryEnvironmentID:n.filterOptions.primaryEnvironmentID(),compareEnvironmentID:n.filterOptions.compareEnvironmentID(),options:n.filterOptions.options,pageSize:n.pagingOptions.pageSize,pageNumber:n.pagingOptions.currentPage,filterText:n.filterOptions.filterText};n.sortInfo.columns.length>0&&(i=n.sortInfo.columns[0],t.sortColumn=i.field,t.sortDirection=n.sortInfo.directions[0]);history.replaceState(null,null,"?"+$.param(t));u.fetchDiff(t).success(function(t){n.viewModel.isFetching=!1;p(t)}).error(function(){n.viewModel.isFetching=!1;n.error("An error occurred when connecting to the server.")})};e=r.create(n,"pagingOptions");e.onChange(function(){o()}).mutators({setCurrentPage:function(n,t,i){n.currentPage=t.currentPage=i},setPageSize:function(n,t,i){n.pageSize=t.pageSize=i}});v=r.create(n,"sortInfo");v.onChange(function(){n.pagingOptions.currentPage!=1&&e.setCurrentPage(1);o()}).mutators({sortBy:function(t,i,r,u){u=u||!1;t.fields=[r];t.directions=[u?"desc":"asc"];n.gridOptions.sortBy(r);u&&n.gridOptions.sortBy(r)}}).compareWith(function(n,t){return angular.equals(n.fields,t.fields)&&angular.equals(n.directions,t.directions)}),function(){var t=setInterval(function(){$("div[ng-grid-footer]").length>0&&($(".ngGrid").prepend($("div[ng-grid-footer]")[0]),$(".ngFooterSelectedItems").css("display","none"),n.viewModel.isLoaded=!0,clearInterval(t))},50)}();setTimeout(w,100)}])